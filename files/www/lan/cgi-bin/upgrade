#!/usr/bin/haserl --upload-dir=/tmp --upload-limit=12000
<%
echo -en "content-type: text/plain\r\n\r\n"

case "${GET_func:-$POST_func}" in
	details)
			print() {
					echo "	option $1 '$2'"
				}

			echo "package misc"
			echo "config data 'data'"
			print 'firmware_version' "$(uci -q get freifunk.@settings[0].version)"
			print 'model' "$(cat /tmp/sysinfo/model 2> /dev/null)"
	;;
	apply_firmware)
		path="$POST_firmware"
		keep="$POST_keep_config"

		if [ ! -f "$path" ]; then
			echo "(E) Datei nicht gefunden."
			exit 1
		fi

		if [ "$keep" = "yes" ]; then
			args=""
		else
			args="-n"
		fi

		echo "(I) Starte Firmwareupdate..."

		#apply openwrt or vendor image
		sysupgrade $args $path
	;;
	lookup_upgrade)
		autoupdater -c 2>&1
	;;
	lookup_and_apply_upgrade)
		autoupdater -f 2>&1
	;;
	restore_firmware)
		echo "(I) Alle Einstellungen werden zur&#252;ckgesetzt..."
		echo y | firstboot
		echo "(I) Router wird neugestartet..."
		reboot
	;;
	*)
		echo "(E) Update - ungÃ¼ltiger Befehl: '$GET_func'"
	;;
esac

%>
