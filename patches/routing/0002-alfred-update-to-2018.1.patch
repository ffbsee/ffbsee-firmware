From eedf24940955f992e3420de6ae3b82895a609dd5 Mon Sep 17 00:00:00 2001
From: Moritz Warning <moritzwarning@web.de>
Date: Wed, 2 May 2018 23:55:57 +0200
Subject: [PATCH 2/3] alfred: update to 2018.1

---
 alfred/Makefile            |  8 ++------
 alfred/files/alfred.init   |  4 ++--
 alfred/files/bat-hosts.lua | 29 +++++++++++++++++------------
 3 files changed, 21 insertions(+), 20 deletions(-)

diff --git a/alfred/Makefile b/alfred/Makefile
index 379c0fe..a0d25a5 100644
--- a/alfred/Makefile
+++ b/alfred/Makefile
@@ -7,14 +7,10 @@
 
 include $(TOPDIR)/rules.mk
 
-#
-# The latest alfred git hash in PKG_REV can be obtained from https://git.open-mesh.org/alfred.git
-#
 PKG_NAME:=alfred
-PKG_VERSION:=2016.5
+PKG_VERSION:=2018.1
 PKG_RELEASE:=0
-PKG_MD5SUM:=e03d422ed3b5a162b90e8af13389523f
-PKG_HASH:=37b3babf7f37643cf296be11fb82d5730cf441a5a56f72fba96edae9f149c9d2
+PKG_HASH:=808fa6acf65c7a8e26405115176a5587157f746108cbe5dd974788eb05416d76
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
 PKG_SOURCE_URL:=https://downloads.open-mesh.org/batman/releases/batman-adv-$(PKG_VERSION)
diff --git a/alfred/files/alfred.init b/alfred/files/alfred.init
index 4c9a9e1..8293436 100755
--- a/alfred/files/alfred.init
+++ b/alfred/files/alfred.init
@@ -46,11 +46,11 @@ wait_for_ll_address()
 	for i in $(seq $timeout); do
 		# We look for
 		# - the link-local address (starts with fe80)
-		# - without tentative flag (bit 0x40 in the flags field; the first char of the flags field begins 38 columns after the fe80 prefix
+		# - without tentative flag (bit 0x40 in the flags field; the first char of the fifth field is evaluated)
 		# - on interface $iface
 		if awk '
 			BEGIN { RET=1 }
-			/^fe80.{37} [012389ab]/ { if ($6 == "'"$iface"'") RET=0 }
+			$1 ~ /^fe80/ && $5 ~ /^[012389ab]/ && $6 == "'"$iface"'" { RET=0 }
 			END { exit RET }
 		' /proc/net/if_inet6; then
 			return
diff --git a/alfred/files/bat-hosts.lua b/alfred/files/bat-hosts.lua
index 8648caf..f9fe586 100644
--- a/alfred/files/bat-hosts.lua
+++ b/alfred/files/bat-hosts.lua
@@ -87,19 +87,24 @@ end
 
 local function receive_bat_hosts()
 -- read raw chunks from alfred, convert them to a nested table and call write_bat_hosts
-  local fd = io.popen("alfred -r " .. type_id)
-    --[[ this command returns something like
-    { "54:e6:fc:b9:cb:37", "00:11:22:33:44:55 ham_wlan0\x0a00:22:33:22:33:22 ham_eth0\x0a" },
-    { "90:f6:52:bb:ec:57", "00:22:33:22:33:23 spam\x0a" },
-    ]]--
-
-  if fd then
-    local output = fd:read("*a")
-    if output then
-      assert(loadstring("rows = {" .. output .. "}"))()
-      write_bat_hosts(rows)
+-- "alfred -r" can fail in slave nodes (returns empty stdout), so:
+-- check output is not null before writing /tmp/bat-hosts, and retry 3 times before giving up.
+  for n = 1, 3 do
+    local fd = io.popen("alfred -r " .. type_id)
+      --[[ this command returns something like
+      { "54:e6:fc:b9:cb:37", "00:11:22:33:44:55 ham_wlan0\x0a00:22:33:22:33:22 ham_eth0\x0a" },
+      { "90:f6:52:bb:ec:57", "00:22:33:22:33:23 spam\x0a" },
+      ]]--
+
+    if fd then
+      local output = fd:read("*a")
+      fd:close()
+      if output and output ~= "" then
+        assert(loadstring("rows = {" .. output .. "}"))()
+        write_bat_hosts(rows)
+        break
+      end
     end
-    fd:close()
   end
 end
 
-- 
2.17.0

